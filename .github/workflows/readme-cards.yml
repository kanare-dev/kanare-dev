name: Update README cards

on:
  push:
    branches:
      - main
    paths-ignore:
      - "cards/**/*.svg"
  schedule:
    - cron: "0 0 * * *" # daily at 00:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Build card options
        id: build-options
        shell: bash
        run: |
          EXCLUDE_FILE="cards/top-langs/exclude_repo.txt"

          if [[ -f "$EXCLUDE_FILE" ]]; then
            EXCLUDE_REPO="$(
              grep -vE '^\s*(#|$)' "$EXCLUDE_FILE" \
                | tr -d '\r' \
                | paste -sd, -
            )"
          else
            EXCLUDE_REPO=""
          fi

          OPTIONS="username=${{ github.repository_owner }}&&layout=compact&&langs_count=8"
          if [[ -n "$EXCLUDE_REPO" ]]; then
            OPTIONS="${OPTIONS}&&exclude_repo=${EXCLUDE_REPO}"
          fi

          echo "options=${OPTIONS}" >> "$GITHUB_OUTPUT"

      - name: Generate top languages card
        uses: readme-tools/github-readme-stats-action@v1
        with:
          card: top-langs
          options: ${{ steps.build-options.outputs.options }}&&theme=default
          path: cards/top-langs/top-langs-light.svg
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate top languages card (dark)
        uses: readme-tools/github-readme-stats-action@v1
        with:
          card: top-langs
          options: ${{ steps.build-options.outputs.options }}&&theme=dark
          path: cards/top-langs/top-langs-dark.svg
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit cards
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add cards
          git commit -m "Update README cards" || exit 0
          git push
